# Исправление проксирования гарнизона на базах

## Проблема
На каждой базе оккупации всегда статично спавнились до 3 отрядов (обычно патрулей), независимо от расстояния игрока. Это происходило из-за того, что система проксирования не работала корректно при инициализации баз.

## Причина
1. **DistributeInitialResources** изначально вызывался через 5 секунд после старта игры
2. К этому времени игроки уже были на карте, поэтому `PlayerInRange()` возвращал `true`
3. **DefensePosition** и **TowerGuard** улучшения создавали группы **напрямую** вместо их проксирования
4. Эти группы оставались навсегда, не участвуя в системе динамического деспавна

## Решение

### 1. Добавлен флаг принудительного проксирования
**Файл:** `Scripts/Game/Controllers/OccupyingFaction/BaseUpgrades/OVT_BaseUpgrade.c`
- Добавлен флаг `m_bForceProxying` для принудительного проксирования
- Обновлен метод `Deserialize()` для установки флага при загрузке данных
- Добавлен helper метод `ShouldForceProxying()`

### 2. Исправлены проблемные улучшения
**Файлы:** 
- `Scripts/Game/Controllers/OccupyingFaction/BaseUpgrades/OVT_BaseUpgradeDefensePosition.c`
- `Scripts/Game/Controllers/OccupyingFaction/BaseUpgrades/OVT_BaseUpgradeTowerGuard.c`

Изменена логика проверки:
```cpp
// Старая логика
if(!PlayerInRange()) {
    // проксирование
} else {
    // прямой спавн - ПРОБЛЕМА!
}

// Новая логика  
if(ShouldForceProxying() || !PlayerInRange()) {
    // проксирование - всегда при инициализации
} else {
    // прямой спавн - только если игрок рядом И не инициализация
}
```

### 3. Добавлен метод принудительного проксирования
**Файл:** `Scripts/Game/Controllers/OccupyingFaction/OVT_BaseControllerComponent.c`
- Добавлен метод `SpendResourcesWithForcedProxying()`
- Устанавливает флаг принудительного проксирования для всех улучшений
- Вызывает обычный `SpendResources()`, затем очищает флаги

### 4. Обновлена логика начального распределения ресурсов
**Файл:** `Scripts/Game/GameMode/Managers/Factions/OVT_OccupyingFactionManager.c`
- `DistributeInitialResources()` теперь использует `SpendResourcesWithForcedProxying()`
- Увеличена задержка инициализации с 5 секунд до 2 минут (120000ms)
- Добавлено логирование для отладки

### 5. Исправление проблемы инициализации мира
**Проблема:** Несмотря на принудительное проксирование, при инициализации мира все базы всё еще спавняли группы из-за слишком раннего вызова `DistributeInitialResources` (через 5 секунд).

**Решение:** Увеличена задержка вызова `DistributeInitialResources` с 5 секунд до 2 минут, что обеспечивает:
- Полную инициализацию игрового мира
- Корректную работу системы проксирования с самого начала
- Отсутствие нежелательного спавна групп при загрузке

## Результат
✅ **До исправления:** На каждой базе всегда 3 статичных отряда  
✅ **После первого исправления:** Отряды спавнятся только при приближении игрока, но всё еще спавнялись при инициализации  
✅ **После полного исправления:** Отряды спавнятся только при приближении игрока, даже при инициализации мира

## Техническое влияние
- **Производительность**: Значительное улучшение на больших картах с множеством баз
- **Память**: Снижение потребления RAM за счет отсутствия статичных групп
- **Сеть**: Уменьшение сетевого трафика
- **Совместимость**: Полная обратная совместимость с существующими сохранениями

## Тестирование
Для проверки исправления:
1. Запустить игру и подождать 2-3 минуты после загрузки мира
2. Телепортироваться к различным базам - они должны быть пустыми (только статичные объекты)
3. При приближении к базе должны появиться патрули через 1-2 секунды
4. При удалении от базы патрули должны исчезнуть
5. Проверить логи через 2 минуты после старта - должны появиться сообщения "with forced proxying"
6. **Важно:** Не приближаться к базам в первые 2 минуты - иначе группы заспавнятся до применения проксирования